{% extends 'patient/base.html' %}
{% load static %}

{% block title %}Notifications de Rendez-vous{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
        <!-- En-t√™te -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                        üìÖ Notifications de Rendez-vous
                    </h1>
                    <p class="text-gray-600">
                        G√©rez toutes vos notifications li√©es aux rendez-vous m√©dicaux
                    </p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-blue-600">{{ total_notifications }}</div>
                    <div class="text-sm text-gray-500">Total des notifications</div>
                </div>
            </div>
        </div>

        <!-- Navigation par onglets -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6">
                    <button onclick="showTab('pending')" id="pending-tab" class="tab-button active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                        En attente ({{ pending_notifications.count }})
                    </button>
                    <button onclick="showTab('confirmed')" id="confirmed-tab" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Confirm√©s ({{ confirmed_notifications.count }})
                    </button>
                    <button onclick="showTab('cancelled')" id="cancelled-tab" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Annul√©s ({{ cancelled_notifications.count }})
                    </button>
                </nav>
            </div>
        </div>

        <!-- Contenu des onglets -->
        <div class="space-y-6">
            <!-- Notifications en attente -->
            <div id="pending-content" class="tab-content">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <span class="w-3 h-3 bg-yellow-400 rounded-full mr-3"></span>
                            Rendez-vous en attente de confirmation
                        </h2>
                    </div>
                    <div class="p-6">
                        {% if pending_notifications %}
                            <div class="space-y-4">
                                {% for notification in pending_notifications %}
                                <div class="border border-yellow-200 rounded-lg p-4 bg-yellow-50 hover:bg-yellow-100 transition-colors">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center mb-2">
                                                <span class="text-yellow-600 mr-2">‚è≥</span>
                                                <h3 class="font-semibold text-gray-800">{{ notification.title }}</h3>
                                                {% if notification.is_important %}
                                                    <span class="ml-2 px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">Important</span>
                                                {% endif %}
                                            </div>
                                            <p class="text-gray-600 mb-2">{{ notification.message }}</p>
                                            <div class="text-sm text-gray-500">
                                                {{ notification.created_at|date:"d/m/Y √† H:i" }}
                                            </div>
                                        </div>
                                        <div class="flex space-x-2 ml-4">
                                            {% if not notification.is_read %}
                                                <button onclick="markAsRead({{ notification.id }})" class="px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded hover:bg-blue-200">
                                                    Marquer comme lu
                                                </button>
                                            {% endif %}
                                            <button onclick="deleteNotification({{ notification.id }})" class="px-3 py-1 text-xs bg-red-100 text-red-800 rounded hover:bg-red-200">
                                                Supprimer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-8">
                                <div class="text-gray-400 text-6xl mb-4">üì≠</div>
                                <h3 class="text-lg font-medium text-gray-600 mb-2">Aucune notification en attente</h3>
                                <p class="text-gray-500">Vous n'avez pas de rendez-vous en attente de confirmation.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Notifications confirm√©es -->
            <div id="confirmed-content" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <span class="w-3 h-3 bg-green-400 rounded-full mr-3"></span>
                            Rendez-vous confirm√©s
                        </h2>
                    </div>
                    <div class="p-6">
                        {% if confirmed_notifications %}
                            <div class="space-y-4">
                                {% for notification in confirmed_notifications %}
                                <div class="border border-green-200 rounded-lg p-4 bg-green-50 hover:bg-green-100 transition-colors">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center mb-2">
                                                <span class="text-green-600 mr-2">‚úÖ</span>
                                                <h3 class="font-semibold text-gray-800">{{ notification.title }}</h3>
                                                {% if notification.is_important %}
                                                    <span class="ml-2 px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">Important</span>
                                                {% endif %}
                                            </div>
                                            <p class="text-gray-600 mb-2">{{ notification.message }}</p>
                                            <div class="text-sm text-gray-500">
                                                {{ notification.created_at|date:"d/m/Y √† H:i" }}
                                            </div>
                                        </div>
                                        <div class="flex space-x-2 ml-4">
                                            {% if not notification.is_read %}
                                                <button onclick="markAsRead({{ notification.id }})" class="px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded hover:bg-blue-200">
                                                    Marquer comme lu
                                                </button>
                                            {% endif %}
                                            <button onclick="deleteNotification({{ notification.id }})" class="px-3 py-1 text-xs bg-red-100 text-red-800 rounded hover:bg-red-200">
                                                Supprimer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-8">
                                <div class="text-gray-400 text-6xl mb-4">üì≠</div>
                                <h3 class="text-lg font-medium text-gray-600 mb-2">Aucune notification confirm√©e</h3>
                                <p class="text-gray-500">Vous n'avez pas de rendez-vous confirm√©s r√©cemment.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Notifications annul√©es -->
            <div id="cancelled-content" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <span class="w-3 h-3 bg-red-400 rounded-full mr-3"></span>
                            Rendez-vous annul√©s
                        </h2>
                    </div>
                    <div class="p-6">
                        {% if cancelled_notifications %}
                            <div class="space-y-4">
                                {% for notification in cancelled_notifications %}
                                <div class="border border-red-200 rounded-lg p-4 bg-red-50 hover:bg-red-100 transition-colors">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center mb-2">
                                                <span class="text-red-600 mr-2">‚ùå</span>
                                                <h3 class="font-semibold text-gray-800">{{ notification.title }}</h3>
                                                {% if notification.is_important %}
                                                    <span class="ml-2 px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">Important</span>
                                                {% endif %}
                                            </div>
                                            <p class="text-gray-600 mb-2">{{ notification.message }}</p>
                                            <div class="text-sm text-gray-500">
                                                {{ notification.created_at|date:"d/m/Y √† H:i" }}
                                            </div>
                                        </div>
                                        <div class="flex space-x-2 ml-4">
                                            {% if not notification.is_read %}
                                                <button onclick="markAsRead({{ notification.id }})" class="px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded hover:bg-blue-200">
                                                    Marquer comme lu
                                                </button>
                                            {% endif %}
                                            <button onclick="deleteNotification({{ notification.id }})" class="px-3 py-1 text-xs bg-red-100 text-red-800 rounded hover:bg-red-200">
                                                Supprimer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-8">
                                <div class="text-gray-400 text-6xl mb-4">üì≠</div>
                                <h3 class="text-lg font-medium text-gray-600 mb-2">Aucune notification d'annulation</h3>
                                <p class="text-gray-500">Vous n'avez pas de rendez-vous annul√©s r√©cemment.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Gestion des onglets
function showTab(tabName) {
    // Masquer tous les contenus
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // D√©sactiver tous les onglets
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active', 'border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Afficher le contenu s√©lectionn√©
    document.getElementById(tabName + '-content').classList.remove('hidden');
    
    // Activer l'onglet s√©lectionn√©
    const activeTab = document.getElementById(tabName + '-tab');
    activeTab.classList.add('active', 'border-blue-500', 'text-blue-600');
    activeTab.classList.remove('border-transparent', 'text-gray-500');
}

// Fonctions pour g√©rer les notifications
function markAsRead(notificationId) {
    fetch(`/core/api/notifications/${notificationId}/read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess('Notification marqu√©e comme lue');
            // Recharger la page pour mettre √† jour l'affichage
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showError('Erreur lors de la mise √† jour');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showError('Erreur lors de la mise √† jour');
    });
}

function deleteNotification(notificationId) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette notification ?')) {
        fetch(`/core/api/notifications/${notificationId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showSuccess('Notification supprim√©e');
                // Recharger la page pour mettre √† jour l'affichage
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showError('Erreur lors de la suppression');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showError('Erreur lors de la suppression');
        });
    }
}

// Fonction pour r√©cup√©rer le token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
