{% extends 'doctors/base.html' %}

{% block title %}Mes rendez-vous{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- En-tête -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <h2 class="text-2xl font-bold text-gray-900">Mes rendez-vous</h2>
            <div class="flex space-x-4">
                <div class="relative">
                    <input type="date" class="rounded-md border border-gray-300 px-4 py-2" id="dateFilter">
                </div>
                <select class="rounded-md border border-gray-300 px-4 py-2" id="statusFilter">
                    <option value="all">Tous les statuts</option>
                    <option value="pending">En attente</option>
                    <option value="confirmed">Confirmés</option>
                    <option value="completed">Terminés</option>
                    <option value="cancelled">Annulés</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Calendrier -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <button class="text-gray-600 hover:text-gray-900" onclick="previousWeek()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h3 class="text-lg font-semibold text-gray-900" id="currentWeek"></h3>
            <button class="text-gray-600 hover:text-gray-900" onclick="nextWeek()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <div class="grid grid-cols-7 gap-4">
            {% for day in week_days %}
            <div class="min-h-[200px] border rounded-lg p-3">
                <div class="text-center mb-2">
                    <span class="text-sm font-medium text-gray-900">{{ day.date|date:"D" }}</span>
                    <span class="block text-lg font-bold {% if day.is_today %}text-blue-600{% endif %}">
                        {{ day.date|date:"d" }}
                    </span>
                </div>
                {% for appointment in day.appointments %}
                <div class="mb-2 p-2 rounded-md {% if appointment.status == 'confirmed' %}bg-blue-50 border-blue-200{% elif appointment.status == 'pending' %}bg-yellow-50 border-yellow-200{% elif appointment.status == 'completed' %}bg-green-50 border-green-200{% else %}bg-red-50 border-red-200{% endif %} border">
                    <p class="text-sm font-medium text-gray-900">{{ appointment.time }}</p>
                    <p class="text-sm text-gray-600 truncate">{{ appointment.patient_name }}</p>
                    <div class="mt-1 flex justify-end space-x-2">
                        <button onclick="startConsultation('{{ appointment.id }}')" class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Débuter
                        </button>
                        <button onclick="cancelAppointment('{{ appointment.id }}')" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">
                            Annuler
                        </button>
                    </div>
                </div>
                {% empty %}
                <p class="text-center text-sm text-gray-500">Aucun rendez-vous</p>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Liste des rendez-vous -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Heure</th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for appointment in appointments %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <img class="h-10 w-10 rounded-full" src="https://ui-avatars.com/api/?name={{ appointment.patient.full_name }}" alt="">
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ appointment.patient.full_name }}</div>
                                    <div class="text-sm text-gray-500">{{ appointment.patient.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ appointment.datetime|date:"d/m/Y" }}</div>
                            <div class="text-sm text-gray-500">{{ appointment.datetime|date:"H:i" }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ appointment.type }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if appointment.status == 'completed' %}bg-green-100 text-green-800
                                {% elif appointment.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif appointment.status == 'confirmed' %}bg-blue-100 text-blue-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ appointment.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="startConsultation('{{ appointment.id }}')" class="text-blue-600 hover:text-blue-900">Débuter</button>
                                <button onclick="viewDetails('{{ appointment.id }}')" class="text-gray-600 hover:text-gray-900">Détails</button>
                                <button onclick="cancelAppointment('{{ appointment.id }}')" class="text-red-600 hover:text-red-900">Annuler</button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">Aucun rendez-vous trouvé</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function startConsultation(appointmentId) {
        window.location.href = `/doctors/consultation/${appointmentId}/start/`;
    }

    function viewDetails(appointmentId) {
        window.location.href = `/doctors/appointments/${appointmentId}/`;
    }

    function cancelAppointment(appointmentId) {
        if (confirm('Êtes-vous sûr de vouloir annuler ce rendez-vous ?')) {
            fetch(`/doctors/appointments/${appointmentId}/cancel/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                }
            });
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Filtres
    document.getElementById('dateFilter').addEventListener('change', function(e) {
        // Implémenter le filtrage par date
    });

    document.getElementById('statusFilter').addEventListener('change', function(e) {
        // Implémenter le filtrage par statut
    });

    // Navigation du calendrier
    function previousWeek() {
        // Implémenter la navigation vers la semaine précédente
    }

    function nextWeek() {
        // Implémenter la navigation vers la semaine suivante
    }
</script>
{% endblock %}
