{% extends 'doctors/base.html' %}

{% block title %}Consultations{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- En-tête -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <h2 class="text-2xl font-bold text-gray-900">Consultations</h2>
            <div class="flex space-x-4">
                <select class="rounded-md border border-gray-300 px-4 py-2" id="statusFilter">
                    <option value="all">Tous les statuts</option>
                    <option value="in_progress">En cours</option>
                    <option value="completed">Terminées</option>
                    <option value="cancelled">Annulées</option>
                </select>
                <input type="date" class="rounded-md border border-gray-300 px-4 py-2" id="dateFilter">
            </div>
        </div>
    </div>

    <!-- Consultations en cours -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Consultations en cours</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for consultation in active_consultations %}
            <div class="border rounded-lg p-4 bg-blue-50">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center">
                        <img class="h-10 w-10 rounded-full" src="https://ui-avatars.com/api/?name={{ consultation.patient.full_name }}" alt="">
                        <div class="ml-3">
                            <h4 class="text-sm font-medium text-gray-900">{{ consultation.patient.full_name }}</h4>
                            <p class="text-xs text-gray-500">Début: {{ consultation.start_time|time:"H:i" }}</p>
                        </div>
                    </div>
                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                        En cours
                    </span>
                </div>
                <div class="space-y-2">
                    <a href="{% url 'doctors:consultation_room' consultation.id %}" 
                       class="w-full flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                        Rejoindre la consultation
                    </a>
                    <button onclick="endConsultation('{{ consultation.id }}')"
                            class="w-full flex justify-center items-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50">
                        Terminer la consultation
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center text-gray-500 py-4">
                Aucune consultation en cours
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Historique des consultations -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durée</th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for consultation in consultations %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <img class="h-10 w-10 rounded-full" src="https://ui-avatars.com/api/?name={{ consultation.patient.full_name }}" alt="">
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ consultation.patient.full_name }}</div>
                                    <div class="text-sm text-gray-500">{{ consultation.patient.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ consultation.date|date:"d/m/Y" }}</div>
                            <div class="text-sm text-gray-500">{{ consultation.start_time|time:"H:i" }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ consultation.duration }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if consultation.status == 'completed' %}bg-green-100 text-green-800
                                {% elif consultation.status == 'in_progress' %}bg-blue-100 text-blue-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ consultation.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-3">
                                <a href="{% url 'doctors:consultation_details' consultation.id %}"
                                   class="text-blue-600 hover:text-blue-900">
                                    Détails
                                </a>
                                {% if consultation.status == 'completed' %}
                                <a href="{% url 'doctors:download_summary' consultation.id %}"
                                   class="text-green-600 hover:text-green-900">
                                    Télécharger le résumé
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                            Aucune consultation trouvée
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if consultations.has_other_pages %}
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if consultations.has_previous %}
                <a href="?page={{ consultations.previous_page_number }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Précédent
                </a>
                {% endif %}
                {% if consultations.has_next %}
                <a href="?page={{ consultations.next_page_number }}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Suivant
                </a>
                {% endif %}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Affichage de <span class="font-medium">{{ consultations.start_index }}</span> à
                        <span class="font-medium">{{ consultations.end_index }}</span> sur
                        <span class="font-medium">{{ consultations.paginator.count }}</span> consultations
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if consultations.has_previous %}
                        <a href="?page={{ consultations.previous_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Précédent</span>
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        {% endif %}

                        {% for i in consultations.paginator.page_range %}
                        {% if consultations.number == i %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600">
                            {{ i }}
                        </span>
                        {% else %}
                        <a href="?page={{ i }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            {{ i }}
                        </a>
                        {% endif %}
                        {% endfor %}

                        {% if consultations.has_next %}
                        <a href="?page={{ consultations.next_page_number }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <span class="sr-only">Suivant</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    const statusFilter = document.getElementById('statusFilter');
    const dateFilter = document.getElementById('dateFilter');
    let filterTimeout;

    function applyFilters() {
        const status = statusFilter.value;
        const date = dateFilter.value;
        window.location.href = `?status=${status}&date=${date}`;
    }

    statusFilter.addEventListener('change', applyFilters);
    dateFilter.addEventListener('change', applyFilters);

    function endConsultation(consultationId) {
        if (confirm('Êtes-vous sûr de vouloir terminer cette consultation ?')) {
            fetch(`/doctors/consultations/${consultationId}/end/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                }
            });
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
