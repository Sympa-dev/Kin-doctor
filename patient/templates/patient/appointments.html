{% extends 'patient/base.html' %}

{% block title %}Mes rendez-vous{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900">Mes rendez-vous</h1>
    <p class="mt-1 text-sm text-gray-500">Gérez vos consultations et rendez-vous médicaux</p>
</div>

<!-- Actions Section -->
<div class="mb-6 flex justify-between items-center">
    <div class="flex space-x-3">
        <a href="{% url 'patient:find_doctor' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors duration-200">
            <i class="fas fa-plus mr-2"></i>
            Nouveau rendez-vous
        </a>
    </div>
    <div class="flex items-center space-x-4">
        <div class="relative">
            <select id="doctor-filter" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md" onchange="filterAppointments()">
                <option value="">Tous les médecins</option>
                {% for doctor in unique_doctors %}
                    <option value="{{ doctor.id }}">Dr. {{ doctor.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="relative">
            <select id="status-filter" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md" onchange="filterAppointments()">
                <option value="">Tous les statuts</option>
                <option value="pending">En attente</option>
                <option value="confirmed">Confirmé</option>
                <option value="completed">Terminé</option>
                <option value="cancelled_by_patient">Annulé par vous</option>
                <option value="cancelled_by_doctor">Annulé par le médecin</option>
                <option value="missed">Non présent</option>
            </select>
        </div>
        <div class="relative">
            <select id="date-filter" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md" onchange="filterAppointments()">
                <option value="">Toutes les dates</option>
                <option value="today">Aujourd'hui</option>
                <option value="week">Cette semaine</option>
                <option value="month">Ce mois</option>
                <option value="past">Passés</option>
                <option value="future">À venir</option>
            </select>
        </div>
    </div>
</div>

<!-- Calendar View -->
<div class="bg-white shadow overflow-hidden sm:rounded-md">
    {% if appointments %}
        <ul class="divide-y divide-gray-200">
            {% for appointment in appointments %}
            <li class="appointment-item" 
                data-doctor-id="{{ appointment.doctor.id }}" 
                data-status="{{ appointment.status }}" 
                data-appointment-date="{{ appointment.time_slot.date|date:'Y-m-d' }}">
                <div class="px-4 py-4 sm:px-6 hover:bg-gray-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-12 w-12 rounded-full bg-primary bg-opacity-10 flex items-center justify-center">
                                <i class="fas fa-user-md text-primary text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">
                                    Dr. {{ appointment.doctor.name }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {% if appointment.consultation_reason %}
                                        {{ appointment.consultation_reason.name }}
                                    {% else %}
                                        Consultation générale
                                    {% endif %}
                                </div>
                                {% if appointment.patient_notes %}
                                <div class="text-xs text-gray-400 mt-1">
                                    <i class="fas fa-sticky-note mr-1"></i>
                                    {{ appointment.patient_notes|truncatechars:50 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-right">
                                <div class="text-sm font-medium text-gray-900">
                                    {{ appointment.time_slot.date|date:"d M Y" }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {{ appointment.time_slot.start_time|time:"H:i" }} - {{ appointment.time_slot.end_time|time:"H:i" }}
                                </div>
                                <div class="mt-1">
                                    {% if appointment.status == 'pending' %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                            <i class="fas fa-clock mr-1"></i>
                                            En attente
                                        </span>
                                    {% elif appointment.status == 'confirmed' %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            <i class="fas fa-check mr-1"></i>
                                            Confirmé
                                        </span>
                                    {% elif appointment.status == 'cancelled_by_patient' %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            <i class="fas fa-times mr-1"></i>
                                            Annulé par vous
                                        </span>
                                    {% elif appointment.status == 'cancelled_by_doctor' %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            <i class="fas fa-times mr-1"></i>
                                            Annulé par le médecin
                                        </span>
                                    {% elif appointment.status == 'completed' %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            <i class="fas fa-check-circle mr-1"></i>
                                            Terminé
                                        </span>
                                    {% elif appointment.status == 'missed' %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            <i class="fas fa-user-times mr-1"></i>
                                            Non présent
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                {% if appointment.status == 'pending' or appointment.status == 'confirmed' %}
                                    {% now "Y-m-d" as today %}
                                    {% if appointment.time_slot.date|date:"Y-m-d" > today %}
                                        <form method="post" style="display: inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="appointment_id" value="{{ appointment.id }}">
                                            <button type="submit" name="cancel_appointment" 
                                                    class="p-2 text-gray-400 hover:text-red-500 rounded-full hover:bg-gray-100"
                                                    onclick="return confirm('Êtes-vous sûr de vouloir annuler ce rendez-vous ?')"
                                                    title="Annuler le rendez-vous">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                {% endif %}
                                <button class="p-2 text-gray-400 hover:text-primary rounded-full hover:bg-gray-100"
                                        title="Voir les détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="text-center py-12">
            <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-calendar-times text-gray-400 text-3xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun rendez-vous</h3>
            <p class="text-gray-500 mb-4">Vous n'avez pas encore de rendez-vous programmés.</p>
            <a href="{% url 'patient:find_doctor' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                <i class="fas fa-plus mr-2"></i>
                Prendre un rendez-vous
            </a>
        </div>
    {% endif %}
</div>


</div>

<!-- New Appointment Modal -->
<div class="fixed inset-0 z-50 hidden overflow-y-auto" id="appointmentModal" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex min-h-screen items-end justify-center px-4 pb-20 pt-4 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

        <!-- Modal panel -->
        <div class="inline-block transform overflow-hidden rounded-lg bg-white text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl sm:align-middle">
            <form class="p-6">
                <!-- Header -->
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="text-lg font-medium leading-6 text-gray-900">Nouveau rendez-vous</h3>
                    <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeModal()">
                        <span class="sr-only">Fermer</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Form Fields -->
                <div class="space-y-6">
                    <!-- Type de consultation -->
                    <div>
                        <label for="consultation-type" class="block text-sm font-medium text-gray-700">Type de consultation</label>
                        <select id="consultation-type" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-primary focus:outline-none focus:ring-primary sm:text-sm">
                            <option value="">Sélectionnez un type</option>
                            <option value="general">Consultation générale</option>
                            <option value="suivi">Suivi</option>
                            <option value="urgence">Urgence</option>
                            <option value="specialiste">Consultation spécialiste</option>
                        </select>
                    </div>

                    <!-- Médecin -->
                    <div>
                        <label for="doctor" class="block text-sm font-medium text-gray-700">Médecin</label>
                        <div class="relative mt-1">
                            <select id="doctor" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-primary focus:outline-none focus:ring-primary sm:text-sm">
                                <option value="">Choisissez un médecin</option>
                                <option value="1">Dr. Martin - Médecin généraliste</option>
                                <option value="2">Dr. Dubois - Cardiologue</option>
                                <option value="3">Dr. Bernard - Pédiatre</option>
                            </select>
                        </div>
                    </div>

                    <!-- Date et Heure -->
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">
                        </div>
                        <div>
                            <label for="time" class="block text-sm font-medium text-gray-700">Heure</label>
                            <select id="time" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-primary focus:outline-none focus:ring-primary sm:text-sm">
                                <option value="">Sélectionnez une heure</option>
                                <option value="09:00">09:00</option>
                                <option value="09:30">09:30</option>
                                <option value="10:00">10:00</option>
                                <option value="10:30">10:30</option>
                                <option value="11:00">11:00</option>
                                <option value="11:30">11:30</option>
                            </select>
                        </div>
                    </div>

                    <!-- Motif -->
                    <div>
                        <label for="reason" class="block text-sm font-medium text-gray-700">Motif de consultation</label>
                        <textarea id="reason" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" placeholder="Décrivez brièvement la raison de votre consultation..."></textarea>
                    </div>

                    <!-- Options supplémentaires -->
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <input id="urgent" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                            <label for="urgent" class="ml-2 block text-sm text-gray-700">Consultation urgente</label>
                        </div>
                        <div class="flex items-center">
                            <input id="first-visit" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                            <label for="first-visit" class="ml-2 block text-sm text-gray-700">Première consultation</label>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2" onclick="closeModal()">
                        Annuler
                    </button>
                    <button type="submit" class="inline-flex justify-center rounded-md border border-transparent bg-primary px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">
                        Confirmer le rendez-vous
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scripts pour le modal et les filtres -->
<script>
function openModal() {
    document.getElementById('appointmentModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('appointmentModal').classList.add('hidden');
}

// Fonction de filtrage des rendez-vous
function filterAppointments() {
    const doctorFilter = document.getElementById('doctor-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    const dateFilter = document.getElementById('date-filter').value;
    
    const appointmentItems = document.querySelectorAll('.appointment-item');
    const today = new Date();
    
    appointmentItems.forEach(item => {
        let show = true;
        
        // Filtre par médecin
        if (doctorFilter && !item.dataset.doctorId.includes(doctorFilter)) {
            show = false;
        }
        
        // Filtre par statut
        if (statusFilter && !item.dataset.status.includes(statusFilter)) {
            show = false;
        }
        
        // Filtre par date
        if (dateFilter) {
            const appointmentDate = new Date(item.dataset.appointmentDate);
            const appointmentTime = new Date(appointmentDate.getTime() + (appointmentDate.getTimezoneOffset() * 60000));
            
            switch (dateFilter) {
                case 'today':
                    if (appointmentTime.toDateString() !== today.toDateString()) {
                        show = false;
                    }
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    if (appointmentTime < weekStart || appointmentTime > weekEnd) {
                        show = false;
                    }
                    break;
                case 'month':
                    if (appointmentTime.getMonth() !== today.getMonth() || appointmentTime.getFullYear() !== today.getFullYear()) {
                        show = false;
                    }
                    break;
                case 'past':
                    if (appointmentTime >= today) {
                        show = false;
                    }
                    break;
                case 'future':
                    if (appointmentTime < today) {
                        show = false;
                    }
                    break;
            }
        }
        
        item.style.display = show ? 'block' : 'none';
    });
    
    // Afficher un message si aucun rendez-vous ne correspond aux filtres
    const visibleItems = document.querySelectorAll('.appointment-item[style*="block"], .appointment-item:not([style*="none"])');
    const noResultsMessage = document.getElementById('no-results-message');
    
    if (visibleItems.length === 0 && appointmentItems.length > 0) {
        if (!noResultsMessage) {
            const ul = document.querySelector('ul');
            const li = document.createElement('li');
            li.id = 'no-results-message';
            li.innerHTML = `
                <div class="text-center py-8">
                    <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-search text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun rendez-vous trouvé</h3>
                    <p class="text-gray-500">Aucun rendez-vous ne correspond aux filtres sélectionnés.</p>
                </div>
            `;
            ul.appendChild(li);
        }
    } else if (noResultsMessage) {
        noResultsMessage.remove();
    }
}

// Fermer le modal quand on clique en dehors
window.onclick = function(event) {
    const modal = document.getElementById('appointmentModal');
    if (event.target == modal) {
        closeModal();
    }
}

// Initialiser les données pour le filtrage
document.addEventListener('DOMContentLoaded', function() {
    const appointmentItems = document.querySelectorAll('li');
    appointmentItems.forEach((item, index) => {
        if (index > 0) { // Skip the first item (header)
            item.classList.add('appointment-item');
            // Les données seront ajoutées dynamiquement par Django
        }
    });
});
</script>

<style>
.appointment-date {
    width: 70px;
}
</style>
{% endblock %}
